name: PIPE-CORE-1.1.6 - Template Regression Tests

on:
  pull_request:
  push:
    branches: ["main"]

concurrency:
  group: template-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      smoke: ${{ steps.filter.outputs.smoke }}
      fast: ${{ steps.filter.outputs.fast }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed areas
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            fast:
              - ".github/workflows/**"
              - ".github/actions/**"
              - "schemas/**"
              - "scripts/**"
              - "internal/**"
            smoke:
              - ".github/workflows/build-*.yml"
              - ".github/actions/**"
              - "schemas/**"
              - "scripts/regression/**"
              - "internal/vendor/runtime-matrix.yml"

  fast-static:
    name: Fast A) Static checks (always)
    needs: [changes]
    if: ${{ needs.changes.outputs.fast == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout brik-pipe-actions
        uses: actions/checkout@v4

      - name: YAML lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            .github/workflows
            .github/actions
            internal
          config_data: |
            extends: default
            rules:
              line-length: disable
              truthy:
                allowed-values: ["true", "false", "on", "off", "yes", "no"]

      - name: actionlint
        uses: rhysd/actionlint@v1.7.3
        with:
          args: "-color"

      - name: Setup Node (scripts)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps (for scripts)
        run: npm ci

      - name: Validate action.yml metadata
        run: node scripts/regression/validate-action-metadata.mjs
        env:
          ACTIONS_DIR: .github/actions

      - name: Validate workflow_call contracts
        run: node scripts/regression/check-workflow-call-contracts.mjs
        env:
          WORKFLOWS_DIR: .github/workflows

  schema-and-validator-tests:
    name: B) Schema + Validator Behavior Tests
    needs: [changes, fast-static]
    if: ${{ needs.changes.outputs.fast == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout brik-pipe-actions
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps
        run: npm ci

      - name: Run schema tests (positive + negative)
        run: node scripts/regression/schema-tests.mjs
        env:
          SCHEMA_PATH: schemas/build.schema.json
          MATRIX_PATH: internal/vendor/runtime-matrix.yml

      - name: Validator perf budget (target < 5s)
        run: node scripts/regression/perf-budget.mjs
        env:
          ACTION_PATH: .github/actions/validate-build-config
          EXAMPLE_CONFIG: scripts/regression/fixtures/valid/node.build.yml

  full-smoke:
    name: Full C+D) Smoke builds + evidence checks (only when needed)
    needs: [changes, fast-static]
    if: ${{ needs.changes.outputs.smoke == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        stack: [node, python, java, dotnet, go]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm ci

      - name: Checkout brik-pipe-examples
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/brik-pipe-examples
          path: examples

      - name: Validate build.yml (example)
        uses: ./.github/actions/validate-build-config
        with:
          config_path: examples/${{ matrix.stack }}-api-example/.brik/build.yml
          strict: false
          allow_unsafe_commands: false

      - name: Smoke runner
        run: node scripts/regression/smoke-runner.mjs
        env:
          STACK: ${{ matrix.stack }}
          EXAMPLE_DIR: examples/${{ matrix.stack }}-api-example
          EVIDENCE_ROOT: .audit/PIPE-BUILD/smoke/${{ matrix.stack }}

      - name: Validate evidence against JSON Schema (PASS)
        if: always()
        run: node scripts/regression/validate-evidence.mjs
        env:
          EVIDENCE_ROOT: .audit/PIPE-BUILD/smoke/${{ matrix.stack }}
          EVIDENCE_SCHEMA: scripts/regression/schemas/evidence.schema.json

      - name: Force validation fail + evidence
        run: node scripts/regression/fail-validation.mjs
        env:
          STACK: ${{ matrix.stack }}
          EXAMPLE_DIR: examples/${{ matrix.stack }}-api-example
          ACTION_PATH: .github/actions/validate-build-config

      - name: Validate evidence against JSON Schema (FAIL)
        if: always()
        run: node scripts/regression/validate-evidence.mjs
        env:
          EVIDENCE_ROOT: .audit/PIPE-BUILD/validation-fail/${{ matrix.stack }}
          EVIDENCE_SCHEMA: scripts/regression/schemas/evidence.schema.json

      - name: Upload evidence bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipe-build-evidence-${{ matrix.stack }}
          path: .audit/PIPE-BUILD
