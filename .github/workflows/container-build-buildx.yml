name: container-build-buildx

on:
  workflow_call:
    inputs:
      context:
        type: string
        default: "."
      dockerfile:
        type: string
        default: "Dockerfile"
      working_directory:
        type: string
        default: "."
      image_name:
        type: string
        required: true
      tags:
        type: string
        required: true
      push:
        type: boolean
        default: false

      registry:
        type: string
        default: "ghcr.io"
      auth_mode:
        type: string
        default: "none" # none|secrets|oidc

      cache_enabled:
        type: boolean
        default: true
      cache_mode:
        type: string
        default: "gha" # gha|registry
      cache_repo:
        type: string
        default: ""

      upload_artifacts:
        type: boolean
        default: true

    secrets:
      registry_username:
        required: false
      registry_password:
        required: false

    outputs:
      image_ref:
        value: ${{ jobs.build.outputs.image_ref }}
      digest:
        value: ${{ jobs.build.outputs.digest }}
      audit_bundle_path:
        value: ${{ jobs.build.outputs.audit_bundle_path }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
      digest: ${{ steps.digest.outputs.digest }}
      audit_bundle_path: ${{ steps.evidence.outputs.audit_bundle_path }}

    steps:
      - uses: actions/checkout@v4

      - name: Resolve cache config
        id: cache
        uses: ./.github/actions/container-cache-config
        with:
          builder: buildx
          cache_enabled: ${{ inputs.cache_enabled }}
          cache_mode: ${{ inputs.cache_mode }}
          cache_repo: ${{ inputs.cache_repo }}
          dockerfile: ${{ inputs.dockerfile }}
          allow_cache_write: >-
            ${{ github.event_name != 'pull_request' ||
                (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false) }}
          cache_scope: "buildx"

      - name: Registry auth contract (sanitized)
        id: auth
        uses: ./.github/actions/container-registry-auth
        with:
          builder: buildx
          registry: ${{ inputs.registry }}
          auth_mode: ${{ inputs.auth_mode }}
          push: ${{ inputs.push }}
          registry_username: ${{ secrets.registry_username || '' }}
          registry_password: ${{ secrets.registry_password || '' }}

      - name: Login (secrets mode)
        if: ${{ inputs.push && inputs.auth_mode == 'secrets' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: OIDC notice
        if: ${{ inputs.push && inputs.auth_mode == 'oidc' }}
        run: |
          echo "OIDC selected. Provider-specific login must be done upstream."
          echo "v1 baseline: use secrets for GHCR; use registry-specific OIDC for ECR/GCR/ACR."

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build metadata
        id: meta
        run: |
          echo "image_ref=${{ inputs.image_name }}" >> "$GITHUB_OUTPUT"

      - name: Build (Buildx)
        id: buildx
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          start=$(date +%s%3N)

          IFS=',' read -ra TAGS <<< "${{ inputs.tags }}"
          DESTS=()
          TAGS_PUSHED=()

          for t in "${TAGS[@]}"; do
            tt="$(echo "$t" | xargs)"
            [ -z "$tt" ] && continue
            DESTS+=( "--tag" "${{ inputs.image_name }}:${tt}" )
            TAGS_PUSHED+=( "${tt}" )
          done

          if [ "${{ inputs.push }}" = "true" ]; then
            PUSH_FLAG="--push"
          else
            PUSH_FLAG="--load"
          fi

          CACHE_FROM="${{ steps.cache.outputs.cache_from }}"
          CACHE_TO="${{ steps.cache.outputs.cache_to }}"
          CACHE_ARGS=()
          [ -n "$CACHE_FROM" ] && CACHE_ARGS+=( "--cache-from" "$CACHE_FROM" )
          [ -n "$CACHE_TO" ] && CACHE_ARGS+=( "--cache-to" "$CACHE_TO" )

          LOG="/tmp/buildx.log"
          docker buildx build \
            --file "${{ inputs.dockerfile }}" \
            "${DESTS[@]}" \
            "${CACHE_ARGS[@]}" \
            $PUSH_FLAG \
            "${{ inputs.context }}" 2>&1 | tee "$LOG"

          end=$(date +%s%3N)
          echo "duration_ms=$((end-start))" >> "$GITHUB_OUTPUT"
          echo "buildx_log=$LOG" >> "$GITHUB_OUTPUT"
          echo "tags_pushed=$(IFS=,; echo "${TAGS_PUSHED[*]}")" >> "$GITHUB_OUTPUT"

      - name: Digest (best-effort)
        id: digest
        if: ${{ inputs.push }}
        run: |
          # v1: best-effort placeholder. Upgrade later via --metadata-file parsing.
          echo "digest=" >> "$GITHUB_OUTPUT"

      - name: Export evidence (always)
        id: evidence
        if: always()
        uses: ./.github/actions/export-container-build-evidence
        with:
          builder: buildx
          working_directory: ${{ inputs.working_directory }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}

          image_name: ${{ inputs.image_name }}
          tags: ${{ inputs.tags }}
          push: ${{ inputs.push }}

          cache: ${{ steps.cache.outputs.cache_enabled }}
          cache_repo: ${{ steps.cache.outputs.cache_repo }}
          registry: ${{ inputs.registry }}

          auth_mode: ${{ inputs.auth_mode }}
          auth_method_used: ${{ steps.auth.outputs.method_used }}

          digest: ${{ steps.digest.outputs.digest }}
          tags_pushed: ${{ steps.buildx.outputs.tags_pushed }}

          buildx_log: ${{ steps.buildx.outputs.buildx_log }}
          duration_ms: ${{ steps.buildx.outputs.duration_ms }}
          cache_mode: ${{ steps.cache.outputs.cache_mode }}
          cache_key: ${{ steps.cache.outputs.cache_key }}
          allow_cache_write: ${{ steps.cache.outputs.allow_cache_write }}

      - name: Validate evidence schema
        if: always()
        run: |
          node scripts/regression/validate-evidence.mjs \
            --schema schemas/evidence/container-build.evidence.schema.json \
            --file .audit/PIPE-CONTAINER-BUILD/metadata.json

      - name: Upload evidence
        if: ${{ inputs.upload_artifacts && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: pipe-container-build-evidence-buildx
          path: .audit/PIPE-CONTAINER-BUILD
