# -----------------------------------------------------------------------------
# BrikByteOS Pipelines — Reusable Workflow: build-java (v1)
#
# "Docstring" (Purpose / Contract):
#   This reusable workflow provides the canonical BrikByte build sequence for Java
#   repositories as part of PIPE-CORE-1.1.2 (Build Automation v1).
#
# What it guarantees:
#   1) Deterministic build sequence: restore -> lint? -> test? -> build
#   2) Java version selection from the canonical runtime matrix (vendored into this repo)
#   3) Build tool selection (Maven or Gradle) with predictable defaults
#   4) Audit-ready build evidence emitted to: .audit/PIPE-BUILD/
#   5) Evidence export runs even when earlier steps fail (if: always())
#
# Who calls this:
#   Any repo can call it via workflow_call, e.g.:
#     jobs:
#       build:
#         uses: BrikByte-Studios/brik-pipe-actions/.github/workflows/build-java.yml@v1
#         with:
#           working_directory: "."
#           runtime_version: "21"     # optional override (defaults from runtime matrix)
#           build_tool: "maven"       # optional (defaults from runtime matrix)
#
# Inputs:
#   - working_directory: repo subdir to run commands in (supports multi-module in subdirs)
#   - runtime_version: override Java version (default resolved from matrix)
#   - build_tool: maven|gradle (optional; default resolved from matrix)
#   - run_lint: toggle lint/quality checks
#   - run_tests: toggle tests (enabled by default for v1)
#   - lint_command/test_command/build_command: optional command overrides
#   - upload_artifacts: upload .audit evidence as a run artifact
#   - artifact_paths: comma-separated build outputs captured in evidence summary
#
# Outputs:
#   - build_verdict: pass|fail (simple caller-friendly status)
#   - runtime_used: the resolved Java version actually used
#   - audit_bundle_path: where evidence was written (typically .audit/PIPE-BUILD)
#
# Notes (Java-specific):
#   - "Install/Restore" pre-fetches dependencies:
#       Maven: dependency:go-offline
#       Gradle: dependencies
#   - Default lint is a "check without tests" style:
#       Maven: verify -DskipTests
#       Gradle: check -x test
#   - Default build produces packages without rerunning tests:
#       Maven: package -DskipTests
#       Gradle: build -x test
# -----------------------------------------------------------------------------

name: "brik: build-java (v1)"

on:
  # Reusable workflows are invoked by other workflows using "uses:".
  workflow_call:
    inputs:
      # Path to execute build commands from. Supports monorepos or nested services.
      working_directory: {type: string, default: "."}

      # Optional override for the Java version. If blank, resolve from runtime-matrix.yml.
      runtime_version: {type: string, default: ""}

      # Optional override for build tool selection.
      # Allowed: maven | gradle
      # If blank, resolve from runtime-matrix.yml (build tool default).
      build_tool: {type: string, default: ""} # maven|gradle

      # Lint step toggle (disabled by default for v1).
      run_lint: {type: boolean, default: false}

      # Test step toggle (enabled by default for v1).
      run_tests: {type: boolean, default: true}

      # Optional overrides. If empty, canonical defaults are used.
      lint_command: {type: string, default: ""}
      test_command: {type: string, default: ""}
      build_command: {type: string, default: ""}

      # Upload evidence (.audit) as a workflow artifact.
      upload_artifacts: {type: boolean, default: true}

      # Used only for evidence summarization (not for publishing artifacts in v1).
      # Comma-separated list to avoid YAML array parsing complexity in workflow_call.
      artifact_paths: {type: string, default: "target"}

    outputs:
      # Caller-friendly outputs: keep consistent across all stacks.
      build_verdict:
        value: ${{ jobs.build.outputs.build_verdict }}
      runtime_used:
        value: ${{ jobs.build.outputs.runtime_used }}
      audit_bundle_path:
        value: ${{ jobs.build.outputs.audit_bundle_path }}
jobs:
  build:
    # Runner baseline for v1. Can be tightened later via runner policy packs.
    runs-on: ubuntu-latest

    outputs:
      # Expose a simple pass/fail result for the caller.
      build_verdict: ${{ steps.verdict.outputs.build_verdict }}

      # Propagate the resolved runtime from the resolve step.
      runtime_used: ${{ steps.resolve.outputs.runtime_version }}

      # Propagate the evidence path from the evidence exporter action.
      audit_bundle_path: ${{ steps.evidence.outputs.audit_bundle_path }}

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - uses: actions/checkout@v4

      - name: Validate build config (.brik/build.yml)
        id: validate
        continue-on-error: true
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/validate-build-config@main
        with:
          config_path: "${{ inputs.working_directory }}/.brik/build.yml"
          strict: "false"

      - name: Stop if build config invalid (after evidence)
        if: always()
        shell: bash
        run: |
          if [ "${{ steps.validate.outcome }}" != "success" ]; then
            echo "❌ Build config validation failed. See .audit/PIPE-BUILD/validation/validation-summary.md"
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 2) Resolve runtime defaults using the canonical runtime matrix
      #    - Reads vendored runtime-matrix.yml within this repo
      #    - Applies override if inputs.runtime_version is provided
      #    - Also returns a default build tool (maven/gradle) for Java
      # -----------------------------------------------------------------------
      - name: Resolve runtime defaults (matrix)
        id: resolve
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/resolve-runtime@main
        with:
          runtime_name: java
          runtime_version: ${{ inputs.runtime_version }}

      # -----------------------------------------------------------------------
      # 3) Setup Java using the resolved runtime
      #    - Uses Temurin distribution for consistency across runners
      # -----------------------------------------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ steps.resolve.outputs.runtime_version }}

      # -----------------------------------------------------------------------
      # 4) Install/Restore dependencies
      #    - Selects Maven/Gradle based on:
      #        1) inputs.build_tool (if provided)
      #        2) resolve.outputs.build_tool_default (from runtime matrix)
      #    - Pre-fetch dependencies to improve determinism and reduce later failures
      # -----------------------------------------------------------------------
      - name: Install/Restore
        id: install
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          TOOL="${{ inputs.build_tool }}"
          # If caller did not specify a build tool, use the runtime matrix default.
          if [ -z "$TOOL" ]; then TOOL="${{ steps.resolve.outputs.build_tool_default }}"; fi
          echo "Using build tool: $TOOL"

          if [ "$TOOL" = "maven" ]; then
            # Maven: pre-download dependencies into local repo
            mvn -B -DskipTests dependency:go-offline 2>&1 | tee "$RUNNER_TEMP/build-install.log"
          elif [ "$TOOL" = "gradle" ]; then
            # Gradle: dependency resolution. Assumes gradle wrapper exists in repo.
            ./gradlew --no-daemon dependencies 2>&1 | tee "$RUNNER_TEMP/build-install.log"
          else
            # Explicitly fail early on unsupported tools (policy enforcement).
            echo "Unsupported build_tool: $TOOL"; exit 2
          fi

      # -----------------------------------------------------------------------
      # 5) Lint step (optional)
      #    - Default command depends on Maven vs Gradle:
      #        Maven: mvn verify -DskipTests
      #        Gradle: ./gradlew check -x test
      # -----------------------------------------------------------------------
      - name: Lint (optional)
        id: lint
        if: ${{ inputs.run_lint }}
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          TOOL="${{ inputs.build_tool }}"
          if [ -z "$TOOL" ]; then TOOL="${{ steps.resolve.outputs.build_tool_default }}"; fi

          CMD="${{ inputs.lint_command }}"
          # If no override is provided, use canonical v1 default based on tool.
          if [ -z "$CMD" ]; then
            if [ "$TOOL" = "maven" ]; then
              CMD="mvn -B -DskipTests verify"
            else
              CMD="./gradlew --no-daemon check -x test"
            fi
          fi

          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/lint.log"

      # -----------------------------------------------------------------------
      # 6) Test step (default on)
      #    - Default command depends on Maven vs Gradle:
      #        Maven: mvn test
      #        Gradle: ./gradlew test
      # -----------------------------------------------------------------------
      - name: Test (default on)
        id: test
        if: ${{ inputs.run_tests }}
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          TOOL="${{ inputs.build_tool }}"
          if [ -z "$TOOL" ]; then TOOL="${{ steps.resolve.outputs.build_tool_default }}"; fi

          CMD="${{ inputs.test_command }}"
          # If no override is provided, use canonical v1 default based on tool.
          if [ -z "$CMD" ]; then
            if [ "$TOOL" = "maven" ]; then
              CMD="mvn -B test"
            else
              CMD="./gradlew --no-daemon test"
            fi
          fi

          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/test.log"

      # -----------------------------------------------------------------------
      # 7) Build step (always runs in v1)
      #    - Default command depends on Maven vs Gradle:
      #        Maven: mvn package -DskipTests
      #        Gradle: ./gradlew build -x test
      # -----------------------------------------------------------------------
      - name: Build
        id: buildstep
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          TOOL="${{ inputs.build_tool }}"
          if [ -z "$TOOL" ]; then TOOL="${{ steps.resolve.outputs.build_tool_default }}"; fi

          CMD="${{ inputs.build_command }}"
          # If no override is provided, use canonical v1 default based on tool.
          if [ -z "$CMD" ]; then
            if [ "$TOOL" = "maven" ]; then
              CMD="mvn -B -DskipTests package"
            else
              CMD="./gradlew --no-daemon build -x test"
            fi
          fi

          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/build.log"

      # -----------------------------------------------------------------------
      # 8) Export build evidence (ALWAYS)
      #    - Must run even when earlier steps fail to avoid audit gaps.
      #    - Writes: .audit/PIPE-BUILD/{metadata,runtime,commands,results,...}
      # -----------------------------------------------------------------------
      - name: Export build evidence (.audit)
        id: evidence
        if: always()
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/export-build-evidence@main
        with:
          # Stack identifier for evidence + downstream reasoning.
          stack: "java"

          # The resolved Java version actually used.
          runtime_used: "${{ steps.resolve.outputs.runtime_version }}"

          # Capture build tool selection into evidence:
          # - prefer caller input when provided, otherwise matrix default.
          toolchain: "buildTool=${{ inputs.build_tool || steps.resolve.outputs.build_tool_default }}"

          # Important for monorepos/multi-module builds: where commands were executed.
          working_directory: "${{ inputs.working_directory }}"

          # Record which steps were intended to run.
          lint_ran: "${{ inputs.run_lint }}"
          test_ran: "${{ inputs.run_tests }}"
          build_ran: "true"

          # Step outcomes are mapped to simple "exit codes" for evidence.
          # Note: GitHub does not expose literal exit codes; outcome is success/failure/skipped.
          lint_exit_code: "${{ steps.lint.outcome == 'success' && '0' || steps.lint.outcome == 'skipped' && '' || '1' }}"
          test_exit_code: "${{ steps.test.outcome == 'success' && '0' || steps.test.outcome == 'skipped' && '' || '1' }}"
          build_exit_code: "${{ steps.buildstep.outcome == 'success' && '0' || '1' }}"

          # Logs captured in runner temp. Exporter action copies them into .audit.
          lint_log: "${{ runner.temp }}/lint.log"
          test_log: "${{ runner.temp }}/test.log"
          build_log: "${{ runner.temp }}/build.log"

          # Build output locations (for summary / teaching). Not used for publish in v1.
          artifact_paths: "${{ inputs.artifact_paths }}"

      # -----------------------------------------------------------------------
      # 9) Upload evidence artifact (optional)
      #    - Uses always() to ensure evidence is uploaded even if build failed.
      # -----------------------------------------------------------------------
      - name: Upload .audit bundle
        if: ${{ inputs.upload_artifacts && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: "audit-pipe-build-java"
          path: .audit/PIPE-BUILD

      # -----------------------------------------------------------------------
      # 10) Final verdict (ALWAYS)
      #     - Produces pass/fail used by caller for gating or reporting.
      #     - Tests/lint may be skipped and still pass.
      # -----------------------------------------------------------------------
      - name: Final verdict
        id: verdict
        if: always()
        shell: bash
        run: |
          # "Pass" means:
          # - build succeeded AND
          # - tests succeeded OR were intentionally skipped AND
          # - lint succeeded OR was intentionally skipped
          if [ "${{ steps.buildstep.outcome }}" = "success" ] && \
             ( [ "${{ steps.test.outcome }}" = "success" ] || [ "${{ steps.test.outcome }}" = "skipped" ] ) && \
             ( [ "${{ steps.lint.outcome }}" = "success" ] || [ "${{ steps.lint.outcome }}" = "skipped" ] ); then
            echo "build_verdict=pass" >> "$GITHUB_OUTPUT"
          else
            echo "build_verdict=fail" >> "$GITHUB_OUTPUT"
          fi
