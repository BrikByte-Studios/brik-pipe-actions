# -----------------------------------------------------------------------------
# BrikByteOS Pipelines — Reusable Workflow: build-dotnet (v1)
#
# "Docstring" (Purpose / Contract):
#   This reusable workflow provides the canonical BrikByte build sequence for .NET
#   repositories as part of PIPE-CORE-1.1.2 (Build Automation v1).
#
# What it guarantees:
#   1) Deterministic build sequence: restore -> lint? -> test? -> build
#   2) Runtime selection from the canonical runtime matrix (vendored into this repo)
#   3) Audit-ready build evidence emitted to: .audit/PIPE-BUILD/
#   4) Evidence export runs even if lint/test/build fails (if: always())
#
# Who calls this:
#   Any repo can call it via workflow_call, e.g.:
#     jobs:
#       build:
#         uses: BrikByte-Studios/brik-pipe-actions/.github/workflows/build-dotnet.yml@v1
#         with:
#           working_directory: "."
#           runtime_version: "8.0.x"   # optional override
#
# Inputs:
#   - working_directory: repo subdir to run commands in (monorepo support)
#   - runtime_version: override .NET SDK version (default resolved from matrix)
#   - run_lint: toggle lint/format check
#   - run_tests: toggle tests
#   - lint_command/test_command/build_command: optional command overrides
#   - upload_artifacts: upload .audit evidence as a run artifact
#   - artifact_paths: comma-separated build outputs captured in evidence summary
#
# Outputs:
#   - build_verdict: pass|fail (simple caller-friendly status)
#   - runtime_used: the resolved SDK version actually used
#   - audit_bundle_path: where evidence was written (typically .audit/PIPE-BUILD)
# -----------------------------------------------------------------------------

name: "brik: build-dotnet (v1)"

on:
  # Reusable workflows are invoked by other workflows using "uses:".
  workflow_call:
    inputs:
      # Path to execute build commands from. Supports monorepos or nested services.
      working_directory: {type: string, default: "."}

      # Optional override for the .NET SDK version. If blank, resolve from runtime-matrix.yml.
      runtime_version: {type: string, default: ""}

      # Lint step toggle (uses dotnet format by default).
      run_lint: {type: boolean, default: false}

      # Test step toggle (enabled by default for v1).
      run_tests: {type: boolean, default: true}

      # Optional overrides. If empty, canonical defaults are used.
      lint_command: {type: string, default: ""}
      test_command: {type: string, default: ""}
      build_command: {type: string, default: ""}

      # Upload evidence (.audit) as a workflow artifact.
      upload_artifacts: {type: boolean, default: true}

      # Used only for evidence summarization (not for publishing artifacts in v1).
      # Comma-separated list to avoid YAML array parsing complexity in workflow_call.
      artifact_paths: {type: string, default: "bin,obj"}
    outputs:
      # Caller-friendly outputs: keep consistent across all stacks.
      build_verdict:
        value: ${{ jobs.build.outputs.build_verdict }}
      runtime_used:
        value: ${{ jobs.build.outputs.runtime_used }}
      audit_bundle_path:
        value: ${{ jobs.build.outputs.audit_bundle_path }}

jobs:
  build:
    # Runner baseline for v1. Can be tightened later via runner policy packs.
    runs-on: ubuntu-latest

    outputs:
      # Expose a simple pass/fail result for the caller.
      build_verdict: ${{ steps.verdict.outputs.build_verdict }}

      # Propagate the resolved runtime from the resolve step.
      runtime_used: ${{ steps.resolve.outputs.runtime_version }}

      # Propagate the evidence path from the evidence exporter action.
      audit_bundle_path: ${{ steps.evidence.outputs.audit_bundle_path }}

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - uses: actions/checkout@v4

      - name: Validate build config (.brik/build.yml)
        id: validate
        continue-on-error: true
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/validate-build-config@main
        with:
          config_path: "${{ inputs.working_directory }}/.brik/build.yml"
          strict: "false"

      - name: Stop if build config invalid (after evidence)
        if: always()
        shell: bash
        run: |
          if [ "${{ steps.validate.outcome }}" != "success" ]; then
            echo "❌ Build config validation failed. See .audit/PIPE-BUILD/validation/validation-summary.md"
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 2) Resolve runtime defaults using the canonical runtime matrix
      #    - Reads vendored runtime-matrix.yml within this repo
      #    - Applies override if inputs.runtime_version is provided
      # -----------------------------------------------------------------------
      - name: Resolve runtime defaults (matrix)
        id: resolve
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/resolve-runtime@main
        with:
          runtime_name: dotnet
          runtime_version: ${{ inputs.runtime_version }}

      # -----------------------------------------------------------------------
      # 3) Setup .NET SDK using the resolved runtime
      #    - dotnet-version is resolved from runtime matrix defaults unless overridden
      # -----------------------------------------------------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ steps.resolve.outputs.runtime_version }}

      # -----------------------------------------------------------------------
      # 4) Restore dependencies (canonical: dotnet restore)
      #    - Logs are captured into $RUNNER_TEMP so they can be copied into .audit later
      # -----------------------------------------------------------------------
      - name: Restore
        id: install
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          dotnet restore 2>&1 | tee "$RUNNER_TEMP/build-install.log"

      # -----------------------------------------------------------------------
      # 5) Lint step (optional)
      #    - Default: dotnet format --verify-no-changes
      #    - Only runs if inputs.run_lint == true
      # -----------------------------------------------------------------------
      - name: Lint (optional)
        id: lint
        if: ${{ inputs.run_lint }}
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          CMD="${{ inputs.lint_command }}"
          # If no override is provided, use canonical v1 default.
          if [ -z "$CMD" ]; then CMD="dotnet format --verify-no-changes"; fi
          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/lint.log"

      # -----------------------------------------------------------------------
      # 6) Test step (default on)
      #    - Default: dotnet test --no-restore
      #    - Only runs if inputs.run_tests == true
      # -----------------------------------------------------------------------
      - name: Test (default on)
        id: test
        if: ${{ inputs.run_tests }}
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          CMD="${{ inputs.test_command }}"
          # If no override is provided, use canonical v1 default.
          if [ -z "$CMD" ]; then CMD="dotnet test --no-restore"; fi
          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/test.log"

      # -----------------------------------------------------------------------
      # 7) Build step (always runs in v1)
      #    - Default: dotnet build --no-restore -c Release
      # -----------------------------------------------------------------------
      - name: Build
        id: buildstep
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          CMD="${{ inputs.build_command }}"
          # If no override is provided, use canonical v1 default.
          if [ -z "$CMD" ]; then CMD="dotnet build --no-restore -c Release"; fi
          bash -lc "$CMD" 2>&1 | tee "$RUNNER_TEMP/build.log"

      # -----------------------------------------------------------------------
      # 8) Export build evidence (ALWAYS)
      #    - Must run even when earlier steps fail to avoid audit gaps.
      #    - Writes: .audit/PIPE-BUILD/{metadata,runtime,commands,results,...}
      # -----------------------------------------------------------------------
      - name: Export build evidence (.audit)
        id: evidence
        if: always()
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/export-build-evidence@main
        with:
          # Stack identifier for evidence + downstream reasoning.
          stack: "dotnet"

          # The resolved runtime version actually used.
          runtime_used: "${{ steps.resolve.outputs.runtime_version }}"

          # Toolchain string is intentionally simple v1 metadata.
          toolchain: "buildTool=dotnet"

          # Important for monorepos: where commands were executed.
          working_directory: "${{ inputs.working_directory }}"

          # Record which steps were intended to run.
          lint_ran: "${{ inputs.run_lint }}"
          test_ran: "${{ inputs.run_tests }}"
          build_ran: "true"

          # Step outcomes are mapped to simple "exit codes" for evidence.
          # Note: GitHub does not expose literal exit codes; outcome is success/failure/skipped.
          lint_exit_code: "${{ steps.lint.outcome == 'success' && '0' || steps.lint.outcome == 'skipped' && '' || '1' }}"
          test_exit_code: "${{ steps.test.outcome == 'success' && '0' || steps.test.outcome == 'skipped' && '' || '1' }}"
          build_exit_code: "${{ steps.buildstep.outcome == 'success' && '0' || '1' }}"

          # Logs captured in runner temp. Exporter action copies them into .audit.
          lint_log: "${{ runner.temp }}/lint.log"
          test_log: "${{ runner.temp }}/test.log"
          build_log: "${{ runner.temp }}/build.log"

          # Build output locations (for summary / teaching). Not used for publish in v1.
          artifact_paths: "${{ inputs.artifact_paths }}"

      # -----------------------------------------------------------------------
      # 9) Upload evidence artifact (optional)
      #    - Uses always() to ensure evidence is uploaded even if build failed.
      # -----------------------------------------------------------------------
      - name: Upload .audit bundle
        if: ${{ inputs.upload_artifacts && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: "audit-pipe-build-dotnet"
          path: .audit/PIPE-BUILD

      # -----------------------------------------------------------------------
      # 10) Final verdict (ALWAYS)
      #     - Produces pass/fail used by caller for gating or reporting.
      #     - Tests/lint may be skipped and still pass.
      # -----------------------------------------------------------------------
      - name: Final verdict
        id: verdict
        if: always()
        shell: bash
        run: |
          # "Pass" means:
          # - build succeeded AND
          # - tests succeeded OR were intentionally skipped AND
          # - lint succeeded OR was intentionally skipped
          if [ "${{ steps.buildstep.outcome }}" = "success" ] && \
             ( [ "${{ steps.test.outcome }}" = "success" ] || [ "${{ steps.test.outcome }}" = "skipped" ] ) && \
             ( [ "${{ steps.lint.outcome }}" = "success" ] || [ "${{ steps.lint.outcome }}" = "skipped" ] ); then
            echo "build_verdict=pass" >> "$GITHUB_OUTPUT"
          else
            echo "build_verdict=fail" >> "$GITHUB_OUTPUT"
          fi
