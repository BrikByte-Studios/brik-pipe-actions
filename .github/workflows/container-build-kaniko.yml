name: "brik: container-build-kaniko (v1)"

on:
  workflow_call:
    inputs:
      working_directory:
        type: string
        default: "."
      context:
        type: string
        default: "."
      dockerfile:
        type: string
        default: "Dockerfile"

      image_name:
        type: string
        required: true
      tags:
        type: string
        required: true

      push:
        type: boolean
        default: false

      cache_enabled:
        type: boolean
        default: true
      cache_mode:
        type: string
        default: "registry" # registry only for kaniko v1
      cache_repo:
        type: string
        default: ""

      build_args:
        type: string
        default: ""
      labels:
        type: string
        default: ""

      registry:
        type: string
        default: "ghcr.io"
      auth_mode:
        type: string
        default: "none" # none|secrets|oidc (oidc may be experimental)

      upload_artifacts:
        type: boolean
        default: true
      validate_evidence_schema:
        type: boolean
        default: true

      # --- PIPE-CORE-1.2.5 Tag Policy (v1) ---
      enforce_tag_policy:
        type: boolean
        default: true
      allow_latest:
        type: boolean
        default: false
      release:
        type: boolean
        default: false

    secrets:
      registry_username:
        required: false
      registry_password:
        required: false

    outputs:
      image_ref:
        value: ${{ jobs.build.outputs.image_ref }}
      digest:
        value: ${{ jobs.build.outputs.digest }}
      tags_pushed:
        value: ${{ jobs.build.outputs.tags_pushed }}
      audit_bundle_path:
        value: ${{ jobs.build.outputs.audit_bundle_path }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # needed for GHCR push (secrets-mode)
      id-token: write # only used if auth_mode=oidc (safe to keep; or guard via separate workflow)

    outputs:
      image_ref: ${{ steps.kaniko.outputs.image_ref }}
      digest: ${{ steps.kaniko.outputs.digest }}
      tags_pushed: ${{ steps.kaniko.outputs.tags_pushed }}
      audit_bundle_path: ${{ steps.evidence.outputs.audit_bundle_path }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1) Cache contract: normalize + decide if cache writes allowed
      - name: Resolve cache config
        id: cache
        uses: ./.github/actions/container-cache-config
        with:
          builder: kaniko
          cache_enabled: ${{ inputs.cache_enabled }}
          cache_mode: ${{ inputs.cache_mode }}
          cache_repo: ${{ inputs.cache_repo }}
          dockerfile: ${{ inputs.dockerfile }}
          allow_cache_write: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
          cache_scope: "kaniko"

      # 2) Auth contract: produce sanitized method_used + (optionally) DOCKER_CONFIG path
      - name: Registry auth contract (sanitized)
        id: auth
        uses: ./.github/actions/container-registry-auth
        with:
          builder: kaniko
          registry: ${{ inputs.registry }}
          auth_mode: ${{ inputs.auth_mode }}
          push: ${{ inputs.push }}
          registry_username: ${{ secrets.registry_username || '' }}
          registry_password: ${{ secrets.registry_password || '' }}

      # --- PIPE-CORE-1.2.5: Enforce tag policy BEFORE build/push ---
      - name: Enforce image tagging policy (PIPE-CORE-1.2.5)
        id: tag_policy
        uses: ./.github/actions/enforce-image-tag-policy
        with:
          push: ${{ inputs.push }}
          tags: ${{ inputs.tags }}
          allow_latest: ${{ inputs.allow_latest }}
          release: ${{ inputs.release }}
          evidence_root: .audit/PIPE-CONTAINER-BUILD
          enforce_tag_policy: ${{ inputs.enforce_tag_policy }}

      # 3) Kaniko build step (build-only default via push=false)
      - name: Run Kaniko build (Build-only or Build+Push)
        id: kaniko
        uses: ./.github/actions/container-build-kaniko
        with:
          working_directory: ${{ inputs.working_directory }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}
          image_name: ${{ inputs.image_name }}
          tags: ${{ steps.tag_policy.outputs.tags_resolved }}
          push: ${{ inputs.push }}

          cache: ${{ steps.cache.outputs.cache_enabled }}
          cache_repo: ${{ steps.cache.outputs.cache_repo }}
          allow_cache_write: ${{ steps.cache.outputs.allow_cache_write }}

          build_args: ${{ inputs.build_args }}
          labels: ${{ inputs.labels }}
          registry: ${{ inputs.registry }}

          # IMPORTANT: pass docker config path created by auth helper (secrets-mode)
          docker_config_dir: ${{ steps.auth.outputs.docker_config_dir }}

      # 4) Evidence export (always)
      - name: Export evidence (.audit/PIPE-CONTAINER-BUILD)
        id: evidence
        if: always()
        uses: ./.github/actions/export-container-build-evidence
        with:
          builder: "kaniko"
          working_directory: ${{ inputs.working_directory }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}
          image_name: ${{ inputs.image_name }}
          tags: ${{ steps.tag_policy.outputs.tags_resolved }}
          push: ${{ inputs.push }}

          cache: ${{ steps.cache.outputs.cache_enabled }}
          cache_repo: ${{ steps.cache.outputs.cache_repo }}
          cache_mode: ${{ steps.cache.outputs.cache_mode }}
          cache_key: ${{ steps.cache.outputs.cache_key }}
          allow_cache_write: ${{ steps.cache.outputs.allow_cache_write }}

          auth_mode: ${{ inputs.auth_mode }}
          auth_method_used: ${{ steps.auth.outputs.method_used }}
          registry: ${{ inputs.registry }}

          build_args: ${{ inputs.build_args }}
          labels: ${{ inputs.labels }}

          image_ref: ${{ steps.kaniko.outputs.image_ref }}
          digest: ${{ steps.kaniko.outputs.digest }}
          tags_pushed: ${{ steps.kaniko.outputs.tags_pushed }}

          kaniko_log: ${{ steps.kaniko.outputs.kaniko_log }}
          duration_ms: ${{ steps.kaniko.outputs.duration_ms }}

      # 5) Validate evidence schema (recommended)
      - name: Validate evidence schema
        if: ${{ inputs.validate_evidence_schema && always() }}
        run: |
          node scripts/regression/validate-evidence.mjs \
            --schema schemas/evidence/container-build.evidence.schema.json \
            --file .audit/PIPE-CONTAINER-BUILD/metadata.json

      - name: Validate tag policy evidence schema
        if: ${{ inputs.validate_evidence_schema && always() }}
        run: |
          node scripts/regression/validate-evidence.mjs \
            --schema schemas/evidence/container-tag-policy.evidence.schema.json \
            --file .audit/PIPE-CONTAINER-BUILD/policy/policy-summary.json

      # 6) Upload evidence
      - name: Upload evidence artifact
        if: ${{ inputs.upload_artifacts && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: audit-pipe-container-build-kaniko
          path: .audit/PIPE-CONTAINER-BUILD
