name: "brik: container-build-kaniko (v1)"

on:
  workflow_call:
    inputs:
      working_directory:
        type: string
        default: "."
      context:
        type: string
        default: "."
      dockerfile:
        type: string
        default: "Dockerfile"

      image_name:
        type: string
        required: true
      tags:
        type: string
        required: true

      push:
        type: boolean
        default: false

      cache_enabled:
        type: boolean
        default: true
      cache_mode:
        type: string
        default: "registry" # registry only for kaniko v1
      cache_repo:
        type: string
        default: ""

      build_args:
        type: string
        default: ""
      labels:
        type: string
        default: ""

      registry:
        type: string
        default: "ghcr.io"
      auth_mode:
        type: string
        default: "none" # none|secrets|oidc (oidc may be experimental)

      upload_artifacts:
        type: boolean
        default: true
      validate_evidence_schema:
        type: boolean
        default: true

      # --- Tag Policy (v1) ---
      enforce_tag_policy:
        type: boolean
        default: true
      allow_latest:
        type: boolean
        default: false
      release:
        type: boolean
        default: false

    secrets:
      registry_username:
        required: false
      registry_password:
        required: false

    outputs:
      image_ref:
        value: ${{ jobs.build.outputs.image_ref }}
      digest:
        value: ${{ jobs.build.outputs.digest }}
      tags_pushed:
        value: ${{ jobs.build.outputs.tags_pushed }}
      audit_bundle_path:
        value: ${{ jobs.build.outputs.audit_bundle_path }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      image_ref: ${{ steps.kaniko.outputs.image_ref }}
      digest: ${{ steps.kaniko.outputs.digest }}
      tags_pushed: ${{ steps.kaniko.outputs.tags_pushed }}
      audit_bundle_path: ${{ steps.evidence.outputs.audit_bundle_path }}

    steps:
      # 1) Checkout CALLER repo (brik-pipe-examples) - contains the app + Dockerfile
      - name: Checkout caller repo
        uses: actions/checkout@v4

      # 2) Checkout PIPE actions repo (brik-pipe-actions) into a subfolder
      #    This makes local composite actions + schemas available.
      - name: Checkout brik-pipe-actions (tooling)
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/brik-pipe-actions
          ref: main
          path: .brik/pipe

      # 3) Cache contract
      - name: Resolve cache config
        id: cache
        uses: ./.brik/pipe/.github/actions/container-cache-config
        with:
          builder: kaniko
          cache_enabled: ${{ inputs.cache_enabled }}
          cache_mode: ${{ inputs.cache_mode }}
          cache_repo: ${{ inputs.cache_repo }}
          dockerfile: ${{ inputs.dockerfile }}
          allow_cache_write: >-
            ${{ github.event_name != 'pull_request' ||
                (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false) }}
          cache_scope: "kaniko"

      # 4) Auth contract (produces docker_config_dir for secrets-mode)
      - name: Registry auth contract (sanitized)
        id: auth
        uses: ./.brik/pipe/.github/actions/container-registry-auth
        with:
          builder: kaniko
          registry: ${{ inputs.registry }}
          auth_mode: ${{ inputs.auth_mode }}
          push: ${{ inputs.push }}
          registry_username: ${{ secrets.registry_username || '' }}
          registry_password: ${{ secrets.registry_password || '' }}
      # 5) Tag policy gate BEFORE build/push
      - name: Enforce image tagging policy (PIPE-CORE-1.2.5)
        id: tag_policy
        uses: ./.brik/pipe/.github/actions/enforce-image-tag-policy
        env:
          INPUT_PUSH: ${{ inputs.push }}
          INPUT_TAGS: ${{ inputs.tags }}
          INPUT_ALLOW_LATEST: ${{ inputs.allow_latest }}
          INPUT_RELEASE: ${{ inputs.release }}
          INPUT_EVIDENCE_ROOT: .audit/PIPE-CONTAINER-BUILD
          INPUT_ENFORCE_TAG_POLICY: ${{ inputs.enforce_tag_policy }}
        with:
          push: ${{ inputs.push }}
          tags: ${{ inputs.tags }}
          allow_latest: ${{ inputs.allow_latest }}
          release: ${{ inputs.release }}
          evidence_root: .audit/PIPE-CONTAINER-BUILD
          enforce_tag_policy: ${{ inputs.enforce_tag_policy }}
          
      - name: Debug resolved tags
        run: |
          echo "resolved tags = '${{ steps.tag_policy.outputs.tags_resolved }}'"

      # 6) Kaniko build
      - name: Run Kaniko build (Build-only or Build+Push)
        id: kaniko
        uses: ./.brik/pipe/.github/actions/container-build-kaniko
        with:
          working_directory: ${{ inputs.working_directory }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}
          image_name: ${{ inputs.image_name }}
          tags: ${{ steps.tags_final.outputs.tags_final }}
          push: ${{ inputs.push }}
          cache: ${{ steps.cache.outputs.cache_enabled }}
          cache_repo: ${{ steps.cache.outputs.cache_repo }}
          allow_cache_write: ${{ steps.cache.outputs.allow_cache_write }}

          build_args: ${{ inputs.build_args }}
          labels: ${{ inputs.labels }}
          registry: ${{ inputs.registry }}

          docker_config_dir: ${{ steps.auth.outputs.docker_config_dir }}

      # 7) Evidence export (always)
      - name: Export evidence (.audit/PIPE-CONTAINER-BUILD)
        id: evidence
        if: always()
        uses: ./.brik/pipe/.github/actions/export-container-build-evidence
        with:
          builder: "kaniko"
          working_directory: ${{ inputs.working_directory }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}
          image_name: ${{ inputs.image_name }}
          tags: ${{ steps.tag_policy.outputs.tags_resolved }}
          push: ${{ inputs.push }}

          cache: ${{ steps.cache.outputs.cache_enabled }}
          cache_repo: ${{ steps.cache.outputs.cache_repo }}
          cache_mode: ${{ steps.cache.outputs.cache_mode }}
          cache_key: ${{ steps.cache.outputs.cache_key }}
          allow_cache_write: ${{ steps.cache.outputs.allow_cache_write }}

          auth_mode: ${{ inputs.auth_mode }}
          auth_method_used: ${{ steps.auth.outputs.method_used }}
          registry: ${{ inputs.registry }}

          build_args: ${{ inputs.build_args }}
          labels: ${{ inputs.labels }}

          image_ref: ${{ steps.kaniko.outputs.image_ref }}
          digest: ${{ steps.kaniko.outputs.digest }}
          tags_pushed: ${{ steps.kaniko.outputs.tags_pushed }}

          kaniko_log: ${{ steps.kaniko.outputs.kaniko_log }}
          duration_ms: ${{ steps.kaniko.outputs.duration_ms }}

      # 8) Validate evidence schema (use schemas shipped in brik-pipe-actions)
      - name: Validate evidence schema
        if: ${{ inputs.validate_evidence_schema && always() }}
        run: |
          node .brik/pipe/scripts/regression/validate-evidence.mjs \
            --schema .brik/pipe/schemas/evidence/container-build.evidence.schema.json \
            --file .audit/PIPE-CONTAINER-BUILD/metadata.json

      - name: Validate tag policy evidence schema
        if: ${{ inputs.validate_evidence_schema && always() }}
        run: |
          node .brik/pipe/scripts/regression/validate-evidence.mjs \
            --schema .brik/pipe/schemas/evidence/container-tag-policy.evidence.schema.json \
            --file .audit/PIPE-CONTAINER-BUILD/policy/policy-summary.json

      # 9) Upload evidence
      - name: Upload evidence artifact
        if: ${{ inputs.upload_artifacts && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: audit-pipe-container-build-kaniko
          path: .audit/PIPE-CONTAINER-BUILD